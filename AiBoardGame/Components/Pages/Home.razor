@page "/"
@using AiBoardGame.Models
@using AiBoardGame.Data
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="monopoly-container">
    @if (!isJoined)
    {
        /* ... GIỮ NGUYÊN PHẦN LOBBY ... */
        <div class="lobby-box">
            <h2 class="title">HÀNH TRÌNH THEO CHÂN BÁC</h2>
            <input @bind="inputName" class="input-name" placeholder="Nhập tên của bạn..." maxlength="15" />
            <div class="action-buttons">
                <button class="btn-create" @onclick="CreateRoom">🛠 TẠO PHÒNG</button>
                <div class="join-area">
                    <input @bind="inputRoomCode" class="input-code" placeholder="MÃ" maxlength="4" />
                    <button class="btn-join" @onclick="JoinRoom">VÀO PHÒNG</button>
                </div>
            </div>
            <p class="error-text">@errorMessage</p>
        </div>
    }
    else
    {
        <div class="monopoly-board">
            <div class="room-info-badge">PHÒNG: <b>@currentRoomCode</b> | VÒNG: <b style="color:yellow">@currentRound/10</b></div>

            @for (int i = 0; i < 25; i++)
            {
                var r = i / 5; var c = i % 5; var idx = GetMonopolyIndex(r, c);
                @if (idx != -1)
                {
                    <div class="cell @GetCellColorClass(idx)">
                        <span class="cell-id">@idx</span>
                        <div class="cell-name">@GetCellName(idx)</div>
                        <div class="tokens character-tokens">
                            @foreach (var p in Players.Where(x => x.Position == idx && !x.IsObserver))
                            {
                                <img src="/images/char_@(p.Color.ToLower()).png" class="char-token" title="@p.Name" />
                            }
                        </div>
                    </div>
                }
                else if (r == 2 && c == 2)
                {
                    <div class="center-content">
                        @if (!gameStarted)
                        {
                            /* ... GIỮ NGUYÊN PHẦN SẢNH CHỜ ... */
                            <div class="lobby-waiting">
                                <h5>MÃ PHÒNG: <span class="code-highlight">@currentRoomCode</span></h5>
                                <ul class="player-list-visual">
                                    @foreach (var p in Players)
                                    {
                                        <li class="@(p.IsObserver ? "observer-item" : "")">
                                            @if (!p.IsObserver)
                                            {
                                                <img src="/images/char_@(p.Color.ToLower()).png" class="mini-char" />
                                            }
                                            else
                                            {

                                                <span class="observer-icon">👁️</span>
                                            }
                                            <span class="player-name" style="color:@(p.IsObserver ? "#666" : p.Color)">@p.Name @(p.IsHost ? "👑" : "")</span>
                                        </li>
                                    }
                                </ul>
                                @if (isHost)
                                {
                                    <button class="btn-start" @onclick="StartGame" disabled="@(Players.Count(p => !p.IsObserver) < 2)">BẮT ĐẦU GAME</button>
                                }
                                else
                                {

                                    <p class="blink">Đang chờ chủ phòng bắt đầu...</p>
                                }
                            </div>
                        }
                        else
                        {
                            /* ... GIỮ NGUYÊN PHẦN TRONG GAME ... */
                            <div class="game-status">
                                @if (isRolling)
                                {
                                    <img src="/images/dice 6.gif" class="dice-img" />
                                }
                                else
                                {

                                    <img src="/images/@(lastDiceValue).jpg" class="dice-img" />
                                }

                                @if (amIObserver)
                                {
                                    <p><b>TRỌNG TÀI</b> đang theo dõi...</p>
                                    <p>Đang đợi: @Players[currentPlayerIndex].Name</p>
                 }
                                else if (isMyTurn)
                                {
                                    <button class="btn-roll" @onclick="RequestRoll" disabled="@(isRolling || isPopupActive || isQuizActive || isAttackMode)">ĐỔ XÚC XẮC</button>
                                }
                                else
                                {

                                    <p>Lượt của: <b style="color:@Players[currentPlayerIndex].Color">@Players[currentPlayerIndex].Name</b></p>
                                }
                            </div>
                            <div class="mini-leaderboard">
                                @foreach (var p in Players.Where(x => !x.IsObserver).OrderByDescending(x => x.Score))
                                {
                                    <div class="mini-row game-leaderboard-row">
                                        <img src="/images/char_@(p.Color.ToLower()).png" class="mini-char-leaderboard" />
                                        <span style="color:@p.Color">@p.Name: <b>@p.Score</b> đ</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

@if (isQuizActive && currentQuiz != null)
{
    <div class="modal-overlay">
        <div class="popup-card quiz-card">
            <div class="timer-bar" style="width: @(quizTimeLeft * 10)%"></div> <h4>CÂU HỎI (@currentQuiz.Difficulty điểm) - <span style="color:red">@quizTimeLeft s</span></h4>
            <p class="quiz-content">@currentQuiz.Content</p>
            <div class="quiz-options">
                @for (int i = 0; i < currentQuiz.Options.Count; i++)
                {
                    var index = i;
                    <button class="btn-option" @onclick="() => AnswerQuiz(index)">@currentQuiz.Options[index]</button>
                }
            </div>
        </div>
    </div>
}

@if (isAttackMode)
{
    /* ... GIỮ NGUYÊN ... */
    <div class="modal-overlay">
        <div class="popup-card">
            <h4>CHIẾN THUẬT TẤN CÔNG</h4>
            <p>Chọn đối thủ để trừ 2 điểm:</p>
            <div class="attack-list">
                @foreach (var p in Players.Where(x => !x.IsObserver && x.ConnectionId != hubConnection?.ConnectionId))
                {
                    <button class="btn-attack-target" @onclick="() => AttackPlayer(p)">
                        <img src="/images/char_@(p.Color.ToLower()).png" class="mini-char" /> @p.Name (@p.Score đ)
                    </button>
                }
            </div>
        </div>
    </div>
}

@if (isPopupActive)
{
    /* ... GIỮ NGUYÊN ... */
    <div class="modal-overlay">
        <div class="popup-card">
            <h4>THÔNG BÁO</h4>
            <p>@popupMessage</p>
            @if (isMyTurn && !amIObserver)
            {
                <button class="btn-ok" @onclick="ClosePopup">ĐÃ HIỂU / TIẾP TỤC</button>
            }
            else if (amIObserver)
            {

                <p><i>(Đang chờ người chơi xác nhận...)</i></p>
            }
        </div>
    </div>
}

@if (isGameOver)
{
    <div class="modal-overlay">
        <div class="popup-card winner-card">
            <h3>🏆 TRÒ CHƠI KẾT THÚC 🏆</h3>
            <p>Sau 10 vòng thi đấu căng thẳng, người chiến thắng là:</p>

            @{
                var winner = Players.Where(x => !x.IsObserver).OrderByDescending(x => x.Score).First();
            }

            <img src="/images/char_@(winner.Color.ToLower()).png" class="winner-avatar" />
            <h2 class="winner-name" style="color:@winner.Color">@winner.Name</h2>
            <p class="winner-role">(@GetCharacterName(winner.Color))</p>
            <h1 class="winner-score">@winner.Score Điểm</h1>

            <button class="btn-ok" @onclick="ReloadGame">CHƠI LẠI</button>
        </div>
    </div>
}

<style>
    /* ... GIỮ NGUYÊN CSS CŨ ... */
    .monopoly-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: #2c3e50;
        font-family: 'Segoe UI', sans-serif;
    }

    .monopoly-board {
        display: grid;
        grid-template-columns: repeat(5, 120px);
        grid-template-rows: repeat(5, 120px);
        gap: 5px;
        background: #34495e;
        padding: 10px;
        border: 8px solid #c0392b;
        border-radius: 15px;
        position: relative;
    }

    .room-info-badge {
        position: absolute;
        top: -40px;
        left: 0;
        background: white;
        padding: 5px 15px;
        border-radius: 5px;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .cell {
        background: #ecf0f1;
        border: 1px solid #bdc3c7;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 5px;
        text-align: center;
        position: relative;
        font-size: 0.8rem;
        font-weight: bold;
        overflow: visible;
    }

    .cell-name {
        margin-bottom: 2px;
        font-size: 0.75rem;
    }

    .cell-id {
        position: absolute;
        top: 2px;
        left: 4px;
        font-size: 0.6rem;
        color: rgba(0,0,0,0.4);
    }

    .cell-start {
        background: white;
    }

    .cell-easy {
        background: #a5d6a7;
    }

    .cell-normal {
        background: #ce93d8;
    }

    .cell-hard {
        background: #fff59d;
    }

    .cell-attack {
        background: #ef9a9a;
    }

    .cell-forward {
        background: #90caf9;
    }

    .cell-backward {
        background: #b0bec5;
    }

    .character-tokens {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-end;
        width: 100%;
        height: 100%;
        position: absolute;
        bottom: 2px;
        pointer-events: none;
    }

    .char-token {
        width: 32px;
        height: 32px;
        object-fit: contain;
        margin: -3px;
        filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
        transition: all 0.3s ease;
        z-index: 1;
    }

    .cell:hover .char-token {
        margin: 1px;
        z-index: 10;
        transform: scale(1.1);
    }

    .mini-char {
        width: 24px;
        height: 24px;
        object-fit: contain;
        margin-right: 8px;
        vertical-align: middle;
        border-radius: 4px;
        background: #f0f0f0;
        border: 1px solid #ccc;
    }

    .mini-char-leaderboard {
        width: 20px;
        height: 20px;
        object-fit: contain;
        margin-right: 5px;
        vertical-align: middle;
    }

    .center-content {
        grid-column: 2/5;
        grid-row: 2/5;
        background: white;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .player-list-visual {
        list-style: none;
        padding: 0;
        text-align: left;
        width: 100%;
        max-width: 250px;
        margin-bottom: 15px;
    }

        .player-list-visual li {
            display: flex;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            font-size: 0.9rem;
        }

    .player-name {
        flex-grow: 1;
    }

    .observer-icon {
        margin-right: 8px;
        font-size: 1.2rem;
    }

    .observer-item {
        font-style: italic;
        color: #666;
    }

    .mini-leaderboard {
        margin-top: 10px;
        width: 100%;
        font-size: 0.9rem;
        border-top: 1px solid #eee;
        padding-top: 5px;
    }

    .game-leaderboard-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 3px 0;
    }

    .lobby-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }

    .title {
        color: #c0392b;
        font-weight: bold;
        margin-bottom: 20px;
    }

    .input-name {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .input-code {
        width: 100px;
        padding: 10px;
        text-transform: uppercase;
        text-align: center;
        font-weight: bold;
    }

    .btn-create, .btn-join, .btn-start, .btn-roll, .btn-ok, .btn-guide {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        color: white;
        margin-top: 5px;
        transition: 0.2s;
    }

    .btn-create {
        background: #d32f2f;
        width: 100%;
    }

    .btn-join {
        background: #2980b9;
    }

    .btn-start {
        background: #27ae60;
    }

    .btn-roll {
        background: #c0392b;
    }

    .btn-ok {
        background: #2980b9;
    }

    .dice-img {
        width: 60px;
        height: 60px;
        margin-bottom: 10px;
        border-radius: 8px;
    }

    .error-text {
        color: red;
        margin-top: 10px;
        font-size: 0.9rem;
    }

    .blink {
        animation: blinker 1.5s linear infinite;
        color: #7f8c8d;
        font-style: italic;
    }

    @@keyframes blinker {
        50% {
            opacity: 0;
        }
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }

    .popup-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        min-width: 320px;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: zoomIn 0.3s;
    }

    @@keyframes zoomIn {
        from {
            transform: scale(0.8);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .btn-option {
        display: block;
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        background: #f8f9fa;
        border: 1px solid #ddd;
        cursor: pointer;
        border-radius: 6px;
        font-weight: 500;
        transition: 0.2s;
    }

        .btn-option:hover {
            background: #d32f2f;
            color: white;
            border-color: #d32f2f;
        }

    .btn-attack-target {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        background: #ffcdd2;
        border: 1px solid #e57373;
        cursor: pointer;
        border-radius: 6px;
        text-align: left;
        font-weight: bold;
        color: #c62828;
    }

        .btn-attack-target:hover {
            background: #e57373;
            color: white;
        }

    .quiz-content {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: #2c3e50;
    }

    /* CSS MỚI: Thanh thời gian & Winner */
    .timer-bar {
        height: 5px;
        background: red;
        margin-bottom: 10px;
        transition: width 1s linear;
        border-radius: 5px;
    }

    .winner-card {
        border: 5px solid gold;
        background: #fffbea;
    }

    .winner-avatar {
        width: 100px;
        height: 100px;
        object-fit: contain;
        margin: 10px;
        animation: bounce 1s infinite;
    }

    .winner-name {
        font-size: 2rem;
        margin: 5px 0;
        font-weight: bold;
    }

    .winner-score {
        font-size: 2.5rem;
        color: #d32f2f;
        margin: 10px 0;
        font-weight: bold;
    }

    .winner-role {
        color: #666;
        font-style: italic;
    }

    @@keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }
</style>

@code {
    private string inputName = "", inputRoomCode = "", currentRoomCode = "", errorMessage = "";
    private bool isJoined = false, isHost = false, isMyTurn = false, gameStarted = false, amIObserver = false;
    private List<Player> Players = new();
    private int currentPlayerIndex = 0, lastDiceValue = 1, currentRound = 1;
    private bool isRolling = false, isPopupActive = false, isQuizActive = false, isAttackMode = false, isGuideActive = false, isGameOver = false;
    private string popupMessage = "";
    private QuizQuestion? currentQuiz;
    private HubConnection? hubConnection;

    // MỚI: Biến đếm ngược
    private int quizTimeLeft = 10;
    private CancellationTokenSource? timerCts;

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder().WithUrl(Navigation.ToAbsoluteUri("/gamehub")).Build();

        hubConnection.On<string, List<Player>>("RoomCreated", (code, list) => { currentRoomCode = code; Players = list; isJoined = true; isHost = true; amIObserver = true; InvokeAsync(StateHasChanged); });
        hubConnection.On<List<Player>, bool>("UpdatePlayers", (list, started) => { Players = list; gameStarted = started; if (!isHost) isJoined = true; InvokeAsync(StateHasChanged); });
        hubConnection.On<string>("JoinError", (msg) => { errorMessage = msg; InvokeAsync(StateHasChanged); });

        // Cập nhật: Nhận thêm currentRound
        hubConnection.On<string, int>("GameStarted", (turnId, round) => { gameStarted = true; currentRound = round; UpdateTurn(turnId); });
        hubConnection.On<string, List<Player>, int>("NextTurn", (nextId, list, round) => { Players = list; currentRound = round; UpdateTurn(nextId); });

        // Cập nhật: Game Over
        hubConnection.On<List<Player>>("GameOver", (finalList) =>
        {
            Players = finalList;
            isGameOver = true;
            isQuizActive = false; isPopupActive = false; // Tắt hết popup khác
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<int>("DiceRolled", async (val) =>
        {
            isRolling = true; InvokeAsync(StateHasChanged);
            await Task.Delay(2000);
            lastDiceValue = val; isRolling = false;
            if (isMyTurn)
            {
                var p = Players[currentPlayerIndex];
                p.Position = (p.Position + lastDiceValue) % 16;
                HandleCellLogic(p);
            }
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private void UpdateTurn(string turnId)
    {
        isMyTurn = (hubConnection?.ConnectionId == turnId);
        currentPlayerIndex = Players.FindIndex(p => p.ConnectionId == turnId);
        InvokeAsync(StateHasChanged);
    }

    private async Task CreateRoom() { if (!string.IsNullOrWhiteSpace(inputName)) await hubConnection!.SendAsync("CreateRoom", inputName); }
    private async Task JoinRoom() { if (!string.IsNullOrWhiteSpace(inputName) && !string.IsNullOrWhiteSpace(inputRoomCode)) await hubConnection!.SendAsync("JoinRoom", inputName, inputRoomCode); }
    private async Task StartGame() { if (isHost) await hubConnection!.SendAsync("StartGame"); }
    private async Task RequestRoll() { if (isMyTurn) await hubConnection!.SendAsync("RequestRoll"); }

    private void HandleCellLogic(Player p)
    {
        string color = GetCellColorClass(p.Position);
        if (p.Position == 0)
        {
            popupMessage = "🎉 HOÀN THÀNH! +5 điểm."; p.Score += 5; isPopupActive = true; return;
        }
        switch (color)
        {
            case "cell-easy": StartQuiz(1); break;
            case "cell-normal": StartQuiz(2); break;
            case "cell-hard": StartQuiz(3); break;
            case "cell-attack": isAttackMode = true; break;
            case "cell-forward": p.Position = (p.Position + 2) % 16; popupMessage = "🚀 TIẾN BƯỚC! +2 bước."; isPopupActive = true; break;
            case "cell-backward": p.Position = (p.Position - 2 + 16) % 16; popupMessage = "⚠️ RỦI RO! Lùi 2 bước."; isPopupActive = true; break;
            default: popupMessage = $"Đến ô số {p.Position}"; isPopupActive = true; break;
        }
    }

    // --- MỚI: LOGIC ĐẾM NGƯỢC ---
    private async void StartQuiz(int difficulty)
    {
        currentQuiz = QuestionBank.GetRandomQuestion(difficulty);
        isQuizActive = true;
        quizTimeLeft = 10;

        timerCts?.Cancel(); // Hủy timer cũ nếu có
        timerCts = new CancellationTokenSource();

        try
        {
            while (quizTimeLeft > 0 && isQuizActive)
            {
                await Task.Delay(1000, timerCts.Token);
                quizTimeLeft--;
                StateHasChanged();
            }
            // Hết giờ mà vẫn chưa trả lời -> Trừ điểm
            if (isQuizActive && quizTimeLeft == 0)
            {
                AnswerQuiz(-1); // -1 là mã lỗi hết giờ
            }
        }
        catch (TaskCanceledException) { /* Timer bị hủy do người chơi đã trả lời */ }
    }

    private void AnswerQuiz(int index)
    {
        timerCts?.Cancel(); // Dừng đồng hồ

        if (index == -1)
        { // Hết giờ
            Players[currentPlayerIndex].Score -= 1;
            popupMessage = "⏰ HẾT GIỜ! Bạn bị trừ 1 điểm.";
        }
        else if (currentQuiz != null && index == currentQuiz.CorrectIndex)
        {
            Players[currentPlayerIndex].Score += currentQuiz.Difficulty;
            popupMessage = "✅ CHÍNH XÁC! Cộng điểm.";
        }
        else
        {
            Players[currentPlayerIndex].Score -= 1; // MỚI: Sai bị trừ 1 điểm
            popupMessage = "❌ SAI RỒI! Bạn bị trừ 1 điểm.";
        }
        isQuizActive = false;
        isPopupActive = true;
    }

    private void AttackPlayer(Player target) { target.Score -= 2; popupMessage = $"⚔️ TẤN CÔNG! {target.Name} -2 điểm."; isAttackMode = false; isPopupActive = true; }
    private async Task ClosePopup() { isPopupActive = false; if (isMyTurn) await hubConnection!.SendAsync("EndTurn", Players); }
    private void ReloadGame() { Navigation.Refresh(true); }

    // Helpers
    private int GetMonopolyIndex(int r, int c) { if (r == 0) return c; if (c == 4 && r > 0) return 4 + r; if (r == 4 && c < 4) return 8 + (4 - c); if (c == 0 && r > 0 && r < 4) return 12 + (4 - r); return -1; }
    private string GetCellColorClass(int i) => i switch { 1 or 7 or 14 => "cell-easy", 2 or 9 or 15 => "cell-normal", 3 or 10 => "cell-hard", 4 or 8 or 12 => "cell-attack", 5 or 11 => "cell-forward", 6 or 13 => "cell-backward", _ => "cell-start" };
    private string GetCellName(int i) => i switch { 0 => "BẮT ĐẦU", 4 => "PÁC BÓ", 8 => "VIỆT BẮC", 12 => "BA ĐÌNH", _ => "" };
    private string GetCharacterName(string color) => color.ToLower() switch { "blue" => "nông dân", "green" => "Bộ đội", "orange" => "Công nhân", _ => "Trí thức" };
}